<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ClearShield – Privacy Scanner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #000; color: #fff; font-family: 'Segoe UI', system-ui, sans-serif; }
    .glitch { position: relative; animation: glitch 3s infinite; }
    @keyframes glitch {
      0% { text-shadow: 2px 0 #f4c24d, -2px 0 #00a8ff; }
      2% { text-shadow: -2px 0 #f4c24d, 2px 0 #00a8ff; }
      4%, 100% { text-shadow: none; }
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <main class="w-full max-w-md">
    <section class="bg-black/80 border border-amber-900/30 p-8 rounded-xl text-center backdrop-blur">
      <h1 class="text-3xl font-bold glitch">ClearShield</h1>
      <p class="text-gray-400 mt-2">Scan your digital exposure across 100+ data brokers.<br>See where you’ve been exposed — instantly.</p>
      <form id="form" class="mt-6 space-y-4">
        <input id="query" class="w-full p-3 rounded bg-gray-900 border border-gray-700 text-white placeholder-gray-500"
               placeholder="name@email.com or phone..." required>
        <div class="grid grid-cols-2 gap-3">
          <button type="button" onclick="scan()" class="py-3 bg-amber-500 text-black font-bold rounded">Scan – 9 USDT</button>
          <button type="button" onclick="erase()" class="py-3 bg-red-600 text-white font-bold rounded">Erase – 29 USDT</button>
        </div>
        <p class="text-xs text-gray-500">
          Payments via USDT (TRC20) • Open in TronLink
        </p>
      </form>
      <div id="status" class="mt-6 hidden text-sm p-3 bg-gray-900 rounded"></div>
      <div id="results" class="mt-6 hidden text-left text-sm"></div>
    </section>
    <footer class="text-center text-xs text-gray-600 mt-6">
      Real manual scan • 48-hour report • No logs
    </footer>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/tronweb@5/dist/TronWeb.js"></script>
  <script>
    const USDT_CONTRACT = 'TR7NHqjeKQxGTCuuQdCA3f2Y2Y8pSQ9e6'; // درست
    let WALLET = '';
    
    fetch('/config')
      .then(r => r.json())
      .then(d => WALLET = d.wallet);

    async function ensureTron() {
      if (!window.tronWeb) throw new Error('Install TronLink');
      for (let i = 0; i < 50; i++) {
        if (window.tronWeb.ready) return window.tronWeb;
        await new Promise(r => setTimeout(r, 200));
      }
      throw new Error('TronLink not ready');
    }

    async function pay(amount) {
      if (!WALLET) throw new Error('Wallet not loaded');
      const tronWeb = await ensureTron();
      const contract = await tronWeb.contract().at(USDT_CONTRACT);
      const tx = await contract.transfer(WALLET, amount * 1000000).send({
        feeLimit: 40_000_000
      });
      return tx;
    }

    async function submit(type, amount) {
      const q = document.getElementById('query').value.trim();
      if (!q) return alert('Enter email or phone');
      if (!confirm(`Send ${amount} USDT (TRC20) now?`)) return;
      
      setStatus('Waiting for TronLink confirmation...');
      try {
        const txId = await pay(amount);
        setStatus('Payment sent! Verifying...');
        const res = await fetch('/confirm-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ txId, type, query: q })
        });
        const data = await res.json();
        if (res.ok) {
          setStatus('Payment verified! Processing your request...');
          poll(q);
        } else {
          setStatus('Payment failed: ' + (data.reason || 'unknown'));
        }
      } catch (err) {
        setStatus('Error: ' + err.message);
      }
    }

    function scan() { submit('scan', 9); }
    function erase() { submit('erase', 29); }

    function setStatus(msg) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    function poll(query) {
      const interval = setInterval(async () => {
        const res = await fetch('/jobs');
        const jobs = await res.json();
        const job = jobs.find(j => j.query === query && j.status === 'done');
        if (job) {
          clearInterval(interval);
          renderResults(job.result);
        }
      }, 3000);
    }

    function renderResults(result) {
      const div = document.getElementById('results');
      if (result.scan) {
        const html = result.scan.map(s => 
          `<div class="mb-3 p-3 bg-gray-900/70 rounded border-l-4 border-amber-500">
            <strong>${s.name}</strong><br>
            <a href="${s.url}" target="_blank" class="text-blue-400 text-xs underline">${s.url}</a>
          </div>`
        ).join('');
        div.innerHTML = `<h3 class="font-bold text-amber-400 mb-3">Found on ${result.scan.length} sites</h3>${html}`;
      } else {
        div.innerHTML = '<p class="text-green-400 text-lg">Removal requests sent to all sites!<br>You will receive a full report in 48 hours.</p>';
      }
      div.classList.remove('hidden');
    }
  </script>
</body>
</html>
